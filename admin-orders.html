<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pack 182 Mums - Admin Orders</title>
    <link rel="icon" type="image/png" href="pack182logo.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header img {
            height: 50px;
        }
        
        h1 {
            color: #2d3748;
            font-size: 28px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #4c51bf;
            color: white;
        }
        
        .btn-primary:hover {
            background: #434190;
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .btn-secondary:hover {
            background: #cbd5e0;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 12px;
            color: #718096;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #4c51bf;
        }
        
        .stat-label {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #2d3748;
            margin-top: 5px;
        }
        
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .orders-table th {
            background: #f7fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            font-size: 14px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .orders-table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
        }
        
        .orders-table tr:hover {
            background: #f7fafc;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pending {
            background: #fef5e7;
            color: #f39c12;
        }
        
        .status-paid {
            background: #e8f8f5;
            color: #27ae60;
        }
        
        .status-new {
            background: #ebf5ff;
            color: #3498db;
        }
        
        .status-completed {
            background: #e8f8f5;
            color: #27ae60;
        }
        
        .order-products {
            font-size: 12px;
            color: #718096;
            max-width: 300px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
        
        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .success {
            background: #c6f6d5;
            color: #276749;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .order-details h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #2d3748;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .detail-label {
            font-weight: 600;
            color: #4a5568;
        }
        
        .product-list {
            margin-top: 10px;
        }
        
        .product-item {
            padding: 8px;
            background: #f7fafc;
            margin-bottom: 5px;
            border-radius: 5px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .orders-table {
                font-size: 12px;
            }
            
            .orders-table th,
            .orders-table td {
                padding: 8px;
            }
            
            .hide-mobile {
                display: none;
            }
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 300px;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .login-form input {
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            font-size: 16px;
        }
        
        #version-footer {
            position: fixed;
            bottom: 5px;
            right: 5px;
            padding: 2px 8px;
            background: rgba(255,255,255,0.8);
            font-size: 11px;
            color: #888;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
        <div class="login-box">
            <img src="pack182logo.png" alt="Pack 182 Logo" style="height: 80px; margin-bottom: 20px;">
            <h2 style="margin-bottom: 20px; color: #2d3748;">Admin Login</h2>
            <div class="login-form">
                <input type="password" id="admin-password" placeholder="Enter admin password" onkeyup="if(event.key==='Enter')checkLogin()">
                <button class="btn btn-primary" onclick="checkLogin()" style="width: 100%;">Login</button>
            </div>
            <div id="login-error" class="error" style="display: none; margin-top: 15px;">Incorrect password</div>
        </div>
    </div>
    
    <!-- Main Dashboard -->
    <div class="container" id="dashboard" style="display: none;">
        <div class="header">
            <div class="header-left">
                <img src="pack182logo.png" alt="Pack 182 Logo">
                <h1>Order Management Dashboard</h1>
            </div>
            <div class="header-buttons">
                <button class="btn btn-secondary" onclick="location.href='index.html'">Main Site</button>
                <button class="btn btn-secondary" onclick="location.href='admin-inventory.html'">Inventory Summary</button>
                <button class="btn btn-secondary" onclick="exportOrders()">Export CSV</button>
                <button class="btn btn-primary" onclick="refreshOrders()">Refresh</button>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>
        
        <div id="message-area"></div>
        
        <div class="filters">
            <div class="filter-group">
                <label>Payment Status</label>
                <select id="payment-filter" onchange="filterOrders()">
                    <option value="">All</option>
                    <option value="PENDING">Pending</option>
                    <option value="PAID">Paid</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Order Status</label>
                <select id="status-filter" onchange="filterOrders()">
                    <option value="">All</option>
                    <option value="NEW">New</option>
                    <option value="PROCESSING">Processing</option>
                    <option value="COMPLETED">Completed</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Search</label>
                <input type="text" id="search-input" placeholder="Name, Order ID..." onkeyup="filterOrders()">
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">Total Orders</div>
                <div class="stat-value" id="total-orders">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Revenue</div>
                <div class="stat-value" id="total-revenue">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Pending Payments</div>
                <div class="stat-value" id="pending-payments">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">New Orders</div>
                <div class="stat-value" id="new-orders">0</div>
            </div>
        </div>
        
        <div id="orders-container">
            <div class="loading">Loading orders...</div>
        </div>
    </div>
    
    <!-- Order Details Modal -->
    <div id="order-modal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Order Details</h2>
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            </div>
            <div id="order-details"></div>
        </div>
    </div>
    
    <div id="version-footer">v1.3.5</div>
    
    <script src="js/config.js"></script>
    <script>
        let allOrders = [];
        let filteredOrders = [];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in
            if (sessionStorage.getItem('adminLoggedIn') === 'true') {
                showDashboard();
            }
            document.getElementById('version-footer').textContent = 'v' + CONFIG.VERSION;
        });
        
        // Authentication functions
        function checkLogin() {
            const password = document.getElementById('admin-password').value;
            // Simple password check - in production, this should be server-side
            if (password === 'pack182admin') {
                sessionStorage.setItem('adminLoggedIn', 'true');
                showDashboard();
            } else {
                document.getElementById('login-error').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('login-error').style.display = 'none';
                }, 3000);
            }
        }
        
        function showDashboard() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadOrders();
        }
        
        function logout() {
            sessionStorage.removeItem('adminLoggedIn');
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('admin-password').value = '';
        }
        
        async function loadOrders() {
            try {
                const response = await fetch(`${CONFIG.API_URL}?path=orders&admin=true`);
                const data = await response.json();
                
                if (data.orders) {
                    allOrders = data.orders;
                    displayOrders(allOrders);
                    updateStats();
                } else {
                    showMessage('No orders found', 'error');
                }
            } catch (error) {
                console.error('Failed to load orders:', error);
                showMessage('Failed to load orders. Please try again.', 'error');
            }
        }
        
        function displayOrders(orders) {
            const container = document.getElementById('orders-container');
            
            if (!orders || orders.length === 0) {
                container.innerHTML = '<div class="loading">No orders found</div>';
                return;
            }
            
            let html = `
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Date</th>
                            <th>Customer</th>
                            <th class="hide-mobile">Email</th>
                            <th>Total</th>
                            <th>Payment</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            orders.forEach(order => {
                const date = new Date(order.timestamp).toLocaleDateString();
                const paymentStatus = order.payment_status || 'PENDING';
                const orderStatus = order.order_status || 'NEW';
                
                html += `
                    <tr>
                        <td><strong>${order.order_id}</strong></td>
                        <td>${date}</td>
                        <td>${order.first_name} ${order.last_name}</td>
                        <td class="hide-mobile">${order.email}</td>
                        <td><strong>$${parseFloat(order.total_price).toFixed(2)}</strong></td>
                        <td><span class="status-badge status-${paymentStatus.toLowerCase()}">${paymentStatus}</span></td>
                        <td><span class="status-badge status-${orderStatus.toLowerCase()}">${orderStatus}</span></td>
                        <td>
                            <button class="btn btn-primary" onclick="viewOrder('${order.order_id}')">View</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function viewOrder(orderId) {
            const order = allOrders.find(o => o.order_id === orderId);
            if (!order) return;
            
            let products = [];
            try {
                products = typeof order.products === 'string' ? JSON.parse(order.products) : order.products;
            } catch (e) {
                products = [];
            }
            
            let productsHtml = '';
            products.forEach(product => {
                productsHtml += `
                    <div class="product-item">
                        <strong>${product.title}</strong> - ${product.color}<br>
                        Quantity: ${product.quantity} Ã— $${product.price} = $${(product.quantity * product.price).toFixed(2)}
                    </div>
                `;
            });
            
            const html = `
                <div class="order-details">
                    <h3>Order Information</h3>
                    <div class="detail-row">
                        <span class="detail-label">Order ID:</span>
                        <span>${order.order_id}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Date:</span>
                        <span>${new Date(order.timestamp).toLocaleString()}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Payment Method:</span>
                        <span>${order.payment_method}</span>
                    </div>
                    
                    <h3>Customer Information</h3>
                    <div class="detail-row">
                        <span class="detail-label">Name:</span>
                        <span>${order.first_name} ${order.last_name}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Email:</span>
                        <span>${order.email}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Phone:</span>
                        <span>${order.phone}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Address:</span>
                        <span>${order.address.replace(/\n/g, '<br>')}</span>
                    </div>
                    
                    <h3>Products</h3>
                    <div class="product-list">
                        ${productsHtml}
                    </div>
                    
                    <h3>Total</h3>
                    <div class="detail-row">
                        <span class="detail-label">Total Amount:</span>
                        <span><strong>$${parseFloat(order.total_price).toFixed(2)}</strong></span>
                    </div>
                    
                    ${order.comments ? `
                        <h3>Comments</h3>
                        <p>${order.comments}</p>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('order-details').innerHTML = html;
            document.getElementById('order-modal').style.display = 'flex';
        }
        
        function closeModal() {
            document.getElementById('order-modal').style.display = 'none';
        }
        
        function filterOrders() {
            const paymentFilter = document.getElementById('payment-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            filteredOrders = allOrders.filter(order => {
                const paymentMatch = !paymentFilter || (order.payment_status || 'PENDING') === paymentFilter;
                const statusMatch = !statusFilter || (order.order_status || 'NEW') === statusFilter;
                const searchMatch = !searchTerm || 
                    order.order_id.toLowerCase().includes(searchTerm) ||
                    order.first_name.toLowerCase().includes(searchTerm) ||
                    order.last_name.toLowerCase().includes(searchTerm) ||
                    order.email.toLowerCase().includes(searchTerm);
                
                return paymentMatch && statusMatch && searchMatch;
            });
            
            displayOrders(filteredOrders);
        }
        
        function updateStats() {
            const totalOrders = allOrders.length;
            const totalRevenue = allOrders.reduce((sum, order) => sum + parseFloat(order.total_price || 0), 0);
            const pendingPayments = allOrders.filter(o => (o.payment_status || 'PENDING') === 'PENDING').length;
            const newOrders = allOrders.filter(o => (o.order_status || 'NEW') === 'NEW').length;
            
            document.getElementById('total-orders').textContent = totalOrders;
            document.getElementById('total-revenue').textContent = '$' + totalRevenue.toFixed(2);
            document.getElementById('pending-payments').textContent = pendingPayments;
            document.getElementById('new-orders').textContent = newOrders;
        }
        
        function refreshOrders() {
            showMessage('Refreshing orders...', 'success');
            loadOrders();
        }
        
        // Export orders to CSV
        function exportOrders() {
            if (filteredOrders.length === 0) {
                showMessage('No orders to export', 'error');
                return;
            }
            
            // Create CSV content
            const headers = ['Order ID', 'Date', 'First Name', 'Last Name', 'Email', 'Phone', 'Address', 
                           'Products', 'Total', 'Payment Method', 'Payment Status', 'Order Status', 'Comments'];
            
            const csvRows = [headers.join(',')];
            
            filteredOrders.forEach(order => {
                const products = typeof order.products === 'string' ? 
                    JSON.parse(order.products) : order.products;
                
                const productsList = products.map(p => 
                    `${p.title || p.name} (${p.color}): ${p.quantity}`
                ).join('; ');
                
                const row = [
                    order.order_id,
                    new Date(order.timestamp).toLocaleString(),
                    order.first_name,
                    order.last_name,
                    order.email,
                    order.phone,
                    `"${order.address.replace(/"/g, '""').replace(/\n/g, ' ')}"`,
                    `"${productsList}"`,
                    order.total_price,
                    order.payment_method,
                    order.payment_status,
                    order.order_status,
                    `"${(order.comments || '').replace(/"/g, '""')}"`
                ];
                
                csvRows.push(row.join(','));
            });
            
            // Download CSV file
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', `mums_orders_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showMessage('Orders exported successfully', 'success');
        }
        
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('message-area');
            messageArea.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 3000);
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('order-modal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>