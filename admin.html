<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pack 182 Mums - Admin Dashboard</title>
    <link rel="icon" type="image/png" href="pack182logo.png">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header img {
            height: 50px;
        }
        
        h1 {
            color: #2d3748;
            font-size: 28px;
        }
        
        h2 {
            color: #2d3748;
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #4c51bf;
            color: white;
        }
        
        .btn-primary:hover {
            background: #434190;
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .btn-secondary:hover {
            background: #cbd5e0;
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-success:hover {
            background: #38a169;
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        .nav-tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: #718096;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -12px;
        }
        
        .nav-tab:hover {
            color: #4c51bf;
        }
        
        .nav-tab.active {
            color: #4c51bf;
            border-bottom-color: #4c51bf;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 12px;
            color: #718096;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #4c51bf;
        }
        
        .stat-label {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #2d3748;
            margin-top: 5px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .data-table th {
            background: #f7fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            font-size: 14px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
        }
        
        .data-table tr:hover {
            background: #f7fafc;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pending {
            background: #fef5e7;
            color: #f39c12;
        }
        
        .status-paid {
            background: #e8f8f5;
            color: #27ae60;
        }
        
        .status-new {
            background: #ebf5ff;
            color: #3498db;
        }
        
        .status-completed {
            background: #e8f8f5;
            color: #27ae60;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
        
        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .success {
            background: #c6f6d5;
            color: #276749;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 300px;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .login-form input {
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .order-details h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #2d3748;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .detail-label {
            font-weight: 600;
            color: #4a5568;
        }
        
        .product-list {
            margin-top: 10px;
        }
        
        .product-item {
            padding: 8px;
            background: #f7fafc;
            margin-bottom: 5px;
            border-radius: 5px;
        }
        
        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
        }
        
        .inventory-table thead {
            background: #f7fafc;
        }
        
        .inventory-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            font-size: 14px;
            border: 1px solid #e2e8f0;
        }
        
        .inventory-table td {
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            font-size: 14px;
        }
        
        .inventory-table tbody tr:hover {
            background: #f7fafc;
        }
        
        .product-header {
            background: #edf2f7 !important;
            font-weight: 600;
            font-size: 16px;
        }
        
        .quantity-cell {
            text-align: center;
            font-weight: 600;
            font-size: 16px;
        }
        
        .total-row {
            background: #e6fffa !important;
            font-weight: bold;
        }
        
        .grand-total-row {
            background: #bee3f8 !important;
            font-weight: bold;
            font-size: 16px;
        }
        
        .summary-date {
            text-align: center;
            color: #718096;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        /* Print styles */
        @media print {
            @page {
                size: landscape;
                margin: 0.15in;
            }
            
            body {
                background: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
                padding: 2px;
                max-width: 100%;
            }
            
            .header-buttons,
            .nav-tabs,
            .btn,
            .actions,
            .filters {
                display: none !important;
            }
            
            .tab-content {
                display: none !important;
            }
            
            .tab-content.active {
                display: block !important;
            }
            
            .header {
                border-bottom: 1px solid black;
                margin-bottom: 2px;
                padding-bottom: 2px;
            }
            
            .header h1 {
                font-size: 0.42rem;
            }
            
            .header img {
                height: 15px;
            }
            
            /* Hide original title in print for inventory */
            .print-inventory #dashboard-title {
                display: none;
            }
            
            .print-title {
                display: none;
            }
            
            .print-inventory .print-title {
                display: block;
                font-size: 0.42rem;
                font-weight: bold;
            }
            
            .stats {
                margin-bottom: 2px;
                display: flex;
                gap: 5px;
            }
            
            .stat-card {
                padding: 0.5px;
                flex: 1;
                border: 0.3px solid #ccc;
            }
            
            .stat-label {
                font-size: 0.2rem;
                line-height: 0.9;
            }
            
            .stat-value {
                font-size: 0.28rem;
                line-height: 0.9;
            }
            
            .summary-date {
                font-size: 0.22rem;
                margin-bottom: 1px;
            }
            
            .inventory-section {
                margin-bottom: 2px;
            }
            
            .inventory-section h3 {
                font-size: 0.25rem;
                margin-bottom: 1px;
                line-height: 0.9;
            }
            
            .data-table,
            .inventory-table {
                font-size: 0.175rem;
                width: 100%;
                border-collapse: collapse;
            }
            
            .data-table th,
            .data-table td,
            .inventory-table th,
            .inventory-table td {
                padding: 0px 0.3px;
                border: 0.2px solid #333;
                line-height: 0.8;
                height: auto;
            }
            
            .inventory-table thead {
                background: #f0f0f0 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .product-header {
                background: #e0e0e0 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .total-row {
                background: #d0f0f0 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .grand-total-row {
                background: #c0d0f0 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .data-table,
            .inventory-table {
                font-size: 12px;
            }
            
            .data-table th,
            .data-table td,
            .inventory-table th,
            .inventory-table td {
                padding: 8px;
            }
            
            .hide-mobile {
                display: none;
            }
            
            .nav-tabs {
                overflow-x: auto;
            }
        }
        
        #version-footer {
            position: fixed;
            bottom: 5px;
            right: 5px;
            padding: 2px 8px;
            background: rgba(255,255,255,0.8);
            font-size: 11px;
            color: #888;
            border-radius: 3px;
            font-family: monospace;
        }
        
        @media print {
            #version-footer {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
        <div class="login-box">
            <img src="pack182logo.png" alt="Pack 182 Logo" style="height: 80px; margin-bottom: 20px;">
            <h2 style="margin-bottom: 20px; color: #2d3748;">Admin Login</h2>
            <div class="login-form">
                <input type="password" id="admin-password" placeholder="Enter admin password" onkeyup="if(event.key==='Enter')checkLogin()">
                <button class="btn btn-primary" onclick="checkLogin()" style="width: 100%;">Login</button>
            </div>
            <div id="login-error" class="error" style="display: none; margin-top: 15px;">Incorrect password</div>
        </div>
    </div>
    
    <!-- Main Dashboard -->
    <div class="container" id="dashboard" style="display: none;">
        <div class="header">
            <div class="header-left">
                <img src="pack182logo.png" alt="Pack 182 Logo">
                <h1 id="dashboard-title">Admin Dashboard</h1>
                <h1 class="print-title">Order Summary</h1>
            </div>
            <div class="header-buttons">
                <button class="btn btn-secondary" onclick="location.href='index.html'">Main Site</button>
                <button class="btn btn-primary" onclick="refreshCurrentView()">Refresh</button>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>
        
        <div id="message-area"></div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('orders')">Orders</button>
            <button class="nav-tab" onclick="switchTab('inventory')">Inventory Summary</button>
            <button class="nav-tab" onclick="switchTab('scouts')">Scout Names</button>
            <button class="nav-tab" onclick="switchTab('qrcodes')">QR Codes</button>
            <button class="nav-tab" onclick="switchTab('leaderboard')">Leaderboard</button>
            <button class="nav-tab" onclick="switchTab('helpers')">Helpers to Contact</button>
            <button class="nav-tab" onclick="switchTab('settings')">Settings</button>
        </div>
        
        <!-- Orders Tab -->
        <div id="orders-tab" class="tab-content active">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">Total Orders</div>
                    <div class="stat-value" id="total-orders">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Revenue</div>
                    <div class="stat-value" id="total-revenue">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Pending Payments</div>
                    <div class="stat-value" id="pending-payments">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">New Orders</div>
                    <div class="stat-value" id="new-orders">0</div>
                </div>
            </div>
            
            <div style="text-align: right; margin-bottom: 15px;">
                <button onclick="exportOrders()" class="btn btn-secondary" style="background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                    üìä Export CSV
                </button>
                <button onclick="debugOrders()" class="btn-secondary" style="background: #666; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                    üêõ Debug
                </button>
                <button onclick="generateOrdersPDF()" class="btn-primary" style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                    üìÑ Generate PDF Report
                </button>
            </div>
            
            <div class="filters">
                <div class="filter-group">
                    <label>Payment Status</label>
                    <select id="payment-filter" onchange="filterOrders()">
                        <option value="">All</option>
                        <option value="PENDING">Pending</option>
                        <option value="PAID">Paid</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Order Status</label>
                    <select id="status-filter" onchange="filterOrders()">
                        <option value="">All</option>
                        <option value="NEW">New</option>
                        <option value="PROCESSING">Processing</option>
                        <option value="COMPLETED">Completed</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Scout</label>
                    <select id="scout-filter" onchange="filterOrders()">
                        <option value="">All Scouts</option>
                        <!-- Scout names will be populated here -->
                    </select>
                </div>
                <div class="filter-group">
                    <label>Search</label>
                    <input type="text" id="search-input" placeholder="Name, Order ID..." onkeyup="filterOrders()">
                </div>
            </div>
            
            <div id="orders-container">
                <div class="loading">Loading orders...</div>
            </div>
        </div>
        
        <!-- Inventory Tab -->
        <div id="inventory-tab" class="tab-content">
            <div class="summary-date" id="summary-date"></div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">Total Orders</div>
                    <div class="stat-value" id="inv-total-orders">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Mums</div>
                    <div class="stat-value" id="inv-total-mums">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Revenue</div>
                    <div class="stat-value" id="inv-total-revenue">$0</div>
                </div>
            </div>
            
            <div style="text-align: right; margin-bottom: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button id="vendor-spreadsheet-btn" class="btn btn-primary" onclick="downloadVendorSpreadsheet()" disabled>Download Spreadsheet for Vendor</button>
                <button id="print-summary-btn" class="btn btn-success" onclick="printInventorySummary()" disabled>Print Summary</button>
            </div>
            
            <div id="inventory-container">
                <div class="loading">Loading inventory data...</div>
            </div>
        </div>
        
        <!-- Scout Names Tab -->
        <div id="scouts-tab" class="tab-content">
            <h2>Scout Names Management</h2>
            <p style="color: #718096; margin-bottom: 20px;">Manage and standardize scout names for consistent tracking and leaderboard display.</p>
            
            <div class="stats" style="margin-bottom: 20px;">
                <div class="stat-card">
                    <div class="stat-label">Total Scouts</div>
                    <div class="stat-value" id="total-scouts">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Top Scout</div>
                    <div class="stat-value" id="top-scout">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Top Revenue</div>
                    <div class="stat-value" id="top-revenue">$0</div>
                </div>
            </div>
            
            <div class="actions">
                <button class="btn btn-primary" onclick="saveScoutNames()">Save Changes</button>
                <button class="btn btn-secondary" onclick="loadScoutNames()">Refresh</button>
            </div>
            
            <div style="background: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 10px; border-radius: 5px; margin: 20px 0;">
                <strong>‚ö†Ô∏è Important:</strong> Standardize scout names to ensure accurate tracking. For example, merge "Johnny Smith", "John Smith", and "J. Smith" into one consistent name.
            </div>
            
            <div id="scout-names-container">
                <table class="data-table" id="scout-names-table">
                    <thead>
                        <tr>
                            <th>Original Name</th>
                            <th>Standardized Name</th>
                            <th>Orders</th>
                            <th>Total Revenue</th>
                        </tr>
                    </thead>
                    <tbody id="scout-names-list">
                        <!-- Scout names will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- QR Codes Tab -->
        <div id="qrcodes-tab" class="tab-content">
            <h2>QR Code Management</h2>
            <p style="color: #718096; margin-bottom: 20px;">Manage scout QR codes for personalized order forms.</p>
            <div style="background: #f7fafc; border-radius: 10px; padding: 20px; height: calc(100vh - 300px); min-height: 500px;">
                <iframe src="qrcodes.html" style="width: 100%; height: 100%; border: none; border-radius: 10px;" title="QR Code Management"></iframe>
            </div>
        </div>
        
        <!-- Leaderboard Tab -->
        <div id="leaderboard-tab" class="tab-content">
            <h2>Sales Leaderboard</h2>
            <p style="color: #718096; margin-bottom: 20px;">View top selling scouts and track sales performance.</p>
            <div style="background: #f7fafc; border-radius: 10px; padding: 20px; height: calc(100vh - 300px); min-height: 500px;">
                <iframe src="leaderboard/" style="width: 100%; height: 100%; border: none; border-radius: 10px;" title="Sales Leaderboard"></iframe>
            </div>
        </div>
        
        <!-- Helpers Tab -->
        <div id="helpers-tab" class="tab-content">
            <h2>Helpers to Contact</h2>
            <p style="color: #718096; margin-bottom: 30px;">People interested in helping Pack 182 in other ways.</p>
            
            <div class="filters">
                <input type="text" id="helpers-search" placeholder="Search by name, email, or scout..." style="width: 300px;">
                <button onclick="loadHelpers()" class="btn-filter">Refresh</button>
            </div>
            
            <div class="stats" id="helpers-stats" style="margin-top: 20px;">
                <div class="stat-card">
                    <div class="stat-value" id="total-helpers">0</div>
                    <div class="stat-label">Total Helpers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pending-helpers">0</div>
                    <div class="stat-label">To Contact</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="contacted-helpers">0</div>
                    <div class="stat-label">Contacted</div>
                </div>
            </div>
            
            <table id="helpers-table" class="data-table" style="margin-top: 20px; width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="width: 40px; padding: 12px; background: #f7fafc; text-align: left;">‚úì</th>
                        <th style="width: 15%; padding: 12px; background: #f7fafc; text-align: left;">Date</th>
                        <th style="width: 15%; padding: 12px; background: #f7fafc; text-align: left;">Name</th>
                        <th style="width: 25%; padding: 12px; background: #f7fafc; text-align: left;">Email</th>
                        <th style="width: 15%; padding: 12px; background: #f7fafc; text-align: left;">Scout</th>
                        <th style="width: auto; padding: 12px; background: #f7fafc; text-align: left;">Contacted By</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <h2>Site Settings</h2>
            <p style="color: #718096; margin-bottom: 30px;">Configure your mums sale site settings. Changes are saved automatically.</p>
            
            <div style="max-width: 800px;">
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label>Welcome Title</label>
                    <input type="text" id="setting-welcome_title" style="width: 100%;" onchange="saveSetting('welcome_title', this.value)">
                </div>
                
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label>Welcome Message</label>
                    <textarea id="setting-welcome_message" rows="3" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 5px; font-size: 14px; font-family: inherit;" onchange="saveSetting('welcome_message', this.value)"></textarea>
                </div>
                
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label>Support Modal Title</label>
                    <input type="text" id="setting-support_modal_title" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 5px; font-size: 14px;" placeholder="üéÅ Other Ways to Support Pack 182" onchange="saveSetting('support_modal_title', this.value)">
                </div>
                
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label>Support Modal Description</label>
                    <textarea id="setting-support_modal_description" rows="2" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 5px; font-size: 14px; font-family: inherit;" placeholder="Choose how you'd like to help our scouts!" onchange="saveSetting('support_modal_description', this.value)"></textarea>
                </div>
                
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label>Contact Modal Title</label>
                    <input type="text" id="setting-contact_modal_title" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 5px; font-size: 14px;" placeholder="üíù Help Pack 182" onchange="saveSetting('contact_modal_title', this.value)">
                </div>
                
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label>Contact Modal Description</label>
                    <textarea id="setting-contact_modal_description" rows="2" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 5px; font-size: 14px; font-family: inherit;" placeholder="Thank you for your interest! Someone from Pack 182 will reach out to discuss how you can help." onchange="saveSetting('contact_modal_description', this.value)"></textarea>
                </div>
                
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label>Catalog Title</label>
                    <input type="text" id="setting-catalog_title" style="width: 100%;" onchange="saveSetting('catalog_title', this.value)">
                </div>
                
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label>Catalog Subtitle</label>
                    <textarea id="setting-catalog_subtitle" rows="2" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 5px; font-size: 14px; font-family: inherit;" onchange="saveSetting('catalog_subtitle', this.value)" placeholder="Optional subtitle shown below the catalog title"></textarea>
                </div>
                
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label>Instructions</label>
                    <textarea id="setting-instructions" rows="4" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 5px; font-size: 14px; font-family: inherit;" onchange="saveSetting('instructions', this.value)"></textarea>
                </div>
                
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label>Scout Help Text</label>
                    <input type="text" id="setting-scout_help_text" style="width: 100%;" onchange="saveSetting('scout_help_text', this.value)" placeholder="Help the scout you are supporting earn a badge by entering their name here.">
                    <small style="color: #718096;">Text shown below the Scout Name field on the order form</small>
                </div>
                
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label>Zelle Email</label>
                    <input type="email" id="setting-zelle_email" style="width: 100%;" onchange="saveSetting('zelle_email', this.value)">
                </div>
                
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label>Zelle QR Code URL</label>
                    <input type="url" id="setting-zelle_qr_url" style="width: 100%;" onchange="saveSetting('zelle_qr_url', this.value)" placeholder="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=...">
                </div>
                
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label>Payment Instructions</label>
                    <textarea id="setting-payment_instructions" rows="2" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 5px; font-size: 14px; font-family: inherit;" onchange="saveSetting('payment_instructions', this.value)"></textarea>
                </div>
                
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label>Pickup Location</label>
                    <input type="text" id="setting-pickup_location" style="width: 100%;" onchange="saveSetting('pickup_location', this.value)">
                </div>
                
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label>Pickup Date</label>
                    <input type="text" id="setting-pickup_date" style="width: 100%;" onchange="saveSetting('pickup_date', this.value)">
                </div>
                
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label>Admin Email</label>
                    <input type="email" id="setting-admin_email" style="width: 100%;" onchange="saveSetting('admin_email', this.value)">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Order Details Modal -->
    <div id="order-modal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Order Details</h2>
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            </div>
            <div id="order-details"></div>
        </div>
    </div>
    
    <div id="version-footer">v1.4.1</div>
    
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <script src="js/config.js"></script>
    <script>
        let allOrders = [];
        let filteredOrders = [];
        let inventoryData = {};
        let currentTab = 'orders';
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in
            if (sessionStorage.getItem('adminLoggedIn') === 'true') {
                showDashboard();
            }
            document.getElementById('version-footer').textContent = 'v' + CONFIG.VERSION;
        });
        
        // Authentication functions
        function checkLogin() {
            const password = document.getElementById('admin-password').value;
            // Simple password check - in production, this should be server-side
            if (password === 'pack182admin') {
                sessionStorage.setItem('adminLoggedIn', 'true');
                showDashboard();
            } else {
                document.getElementById('login-error').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('login-error').style.display = 'none';
                }, 3000);
            }
        }
        
        function showDashboard() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadOrders();
        }
        
        function logout() {
            sessionStorage.removeItem('adminLoggedIn');
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('admin-password').value = '';
        }
        
        function printInventorySummary() {
            // Add class to body for print-specific styles
            document.body.classList.add('print-inventory');
            window.print();
            // Remove class after print dialog
            setTimeout(() => {
                document.body.classList.remove('print-inventory');
            }, 100);
        }
        
        function downloadVendorSpreadsheet() {
            if (typeof XLSX === 'undefined') {
                alert('Excel export library not loaded. Please refresh the page and try again.');
                return;
            }
            
            // Product pricing and cost data (matching vendor format)
            const productInfo = {
                '9" Pot Mum Bundle': { size: '9" Pot', price: 10, cost: 5 },
                '10" Hanging Basket Bundle': { size: '10" Hanging Basket', price: 15, cost: 10 },
                '10" Deck Planter Bundle': { size: '10" Decorative Deck', price: 15, cost: 10 },
                '14" Deck Planter Bundle': { size: '14" Decorative Deck', price: 25, cost: 15 },
                'Apple Basket Bushel Bundle': { size: 'Bushel', price: 35, cost: 20 },
                'Oval Tricolor Pot': { size: '16" Oval Tricolor', price: 20, cost: 10 }
            };
            
            // Create worksheet data
            const wsData = [];
            
            // Add header row
            const headerRow = ['Size', 'Price', 'Cost', 'Quantity', 'Total Price', 'Total Cost', 
                             'Total Profit', 'Profit %', 'Yellow', 'Orange', 'Red', 'Purple', 
                             'White', 'Any Color', 'Total'];
            wsData.push(headerRow);
            
            // Process inventory data
            let grandTotals = {
                quantity: 0,
                totalPrice: 0,
                totalCost: 0,
                totalProfit: 0,
                yellow: 0,
                orange: 0,
                red: 0,
                purple: 0,
                white: 0,
                anyColor: 0,
                total: 0
            };
            
            // Add product rows
            Object.keys(inventoryData).sort().forEach(productName => {
                const product = inventoryData[productName];
                const info = productInfo[productName] || { size: productName, price: 0, cost: 0 };
                
                const quantity = product.total;
                const totalPrice = quantity * info.price;
                const totalCost = quantity * info.cost;
                const totalProfit = totalPrice - totalCost;
                const profitPercent = totalCost > 0 ? Math.round((totalProfit / totalCost) * 100) : 0;
                
                // Get color quantities
                const yellow = product.colors['Yellow'] || 0;
                const orange = product.colors['Orange'] || 0;
                const red = product.colors['Red'] || 0;
                const purple = product.colors['Purple'] || 0;
                const white = product.colors['White'] || 0;
                const tricolor = product.colors['Tricolor'] || 0;
                const anyColor = tricolor; // Tricolor goes in "Any Color" column
                
                const row = [
                    info.size,
                    `$ ${info.price}`,
                    `$ ${info.cost}`,
                    quantity,
                    `$ ${totalPrice.toLocaleString()}`,
                    `$ ${totalCost}`,
                    `$ ${totalProfit}`,
                    profitPercent ? `${profitPercent}%` : '',
                    yellow || 0,
                    orange || 0,
                    red || 0,
                    purple || 0,
                    white || 0,
                    anyColor || 0,
                    quantity
                ];
                
                wsData.push(row);
                
                // Update grand totals
                grandTotals.quantity += quantity;
                grandTotals.totalPrice += totalPrice;
                grandTotals.totalCost += totalCost;
                grandTotals.totalProfit += totalProfit;
                grandTotals.yellow += yellow;
                grandTotals.orange += orange;
                grandTotals.red += red;
                grandTotals.purple += purple;
                grandTotals.white += white;
                grandTotals.anyColor += anyColor;
                grandTotals.total += quantity;
            });
            
            // Add grand total row
            const grandProfitPercent = grandTotals.totalCost > 0 ? 
                Math.round((grandTotals.totalProfit / grandTotals.totalCost) * 100) : 0;
            
            const totalRow = [
                'Grand Total',
                '2024', // Year as shown in example
                grandTotals.quantity,
                '',
                `$ ${grandTotals.totalPrice.toLocaleString()}`,
                `$ ${grandTotals.totalCost.toLocaleString()}`,
                `$ ${grandTotals.totalProfit.toLocaleString()}`,
                `${grandProfitPercent}%`,
                grandTotals.yellow,
                grandTotals.orange,
                grandTotals.red,
                grandTotals.purple,
                grandTotals.white,
                grandTotals.anyColor,
                grandTotals.total
            ];
            wsData.push(totalRow);
            
            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Set column widths
            const colWidths = [
                { wch: 20 }, // Size
                { wch: 8 },  // Price
                { wch: 8 },  // Cost
                { wch: 10 }, // Quantity
                { wch: 12 }, // Total Price
                { wch: 12 }, // Total Cost
                { wch: 12 }, // Total Profit
                { wch: 10 }, // Profit %
                { wch: 8 },  // Yellow
                { wch: 8 },  // Orange
                { wch: 8 },  // Red
                { wch: 8 },  // Purple
                { wch: 8 },  // White
                { wch: 10 }, // Any Color
                { wch: 8 }   // Total
            ];
            ws['!cols'] = colWidths;
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Mums Order Summary');
            
            // Generate filename with date
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            const filename = `Pack182_Mums_Vendor_Order_${dateStr}.xlsx`;
            
            // Write and download
            XLSX.writeFile(wb, filename);
        }
        
        // Debug function to inspect order data
        function debugOrders() {
            if (allOrders.length === 0) {
                console.log('No orders to debug');
                return;
            }
            
            console.log('=== DEBUG: First Order Structure ===');
            const firstOrder = allOrders[0];
            console.log('Full order object:', firstOrder);
            
            let products = firstOrder.products;
            if (typeof products === 'string') {
                try {
                    products = JSON.parse(products);
                } catch (e) {
                    console.error('Failed to parse products:', e);
                    products = [];
                }
            }
            
            console.log('Parsed products:', products);
            
            if (products && Array.isArray(products)) {
                products.forEach((product, index) => {
                    console.log(`Product ${index}:`, {
                        title: product.title,
                        name: product.name,
                        color: product.color,
                        quantity: product.quantity,
                        fullProduct: product
                    });
                });
            }
            
            console.log('=== END DEBUG ===');
            alert('Check console for debug output');
        }
        
        // Generate PDF Report for Orders
        async function generateOrdersPDF() {
            if (allOrders.length === 0) {
                showMessage('No orders to export', 'error');
                return;
            }
            
            // Initialize jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape', 'pt', 'letter');
            
            // Get all available products from the catalog AND their actual ordered colors
            const availableProducts = new Map(); // Map<productName, Set<color>>
            
            // First, collect all products from the catalog
            const catalogProductNames = new Set();
            try {
                const response = await fetch(`${CONFIG.API_URL}?path=products`);
                const data = await response.json();
                if (data.products) {
                    data.products.forEach(product => {
                        if (product.available === true || product.available === 'TRUE' || product.available === 'true') {
                            const fullTitle = product.title;
                            let productName = fullTitle;
                            let color = null;
                            
                            // Check if title contains a dash separator for color
                            if (fullTitle.includes(' - ')) {
                                const parts = fullTitle.split(' - ');
                                productName = parts[0].trim();
                                color = parts[1].trim();
                            } else if (fullTitle.toLowerCase().includes('tricolor')) {
                                productName = fullTitle;
                                color = 'Mixed';
                            } else {
                                // Bundle products without explicit color
                                productName = fullTitle;
                            }
                            
                            // Add to catalog set
                            catalogProductNames.add(productName);
                            
                            // If we have a color, add it
                            if (color) {
                                if (!availableProducts.has(productName)) {
                                    availableProducts.set(productName, new Set());
                                }
                                availableProducts.get(productName).add(color);
                            }
                        }
                    });
                }
                
                // Now scan through orders to find what colors were actually ordered
                allOrders.forEach(order => {
                    let products = order.products;
                    if (typeof products === 'string') {
                        try {
                            products = JSON.parse(products);
                        } catch (e) {
                            products = [];
                        }
                    }
                    
                    if (products && Array.isArray(products)) {
                        products.forEach(product => {
                            const productName = product.title || product.name || 'Unknown';
                            const color = product.color || null;
                            
                            // Only add if this product is in our catalog
                            if (catalogProductNames.has(productName) && color) {
                                if (!availableProducts.has(productName)) {
                                    availableProducts.set(productName, new Set());
                                }
                                availableProducts.get(productName).add(color);
                            }
                        });
                    }
                });
                
                // For any catalog products that still have no colors, add default colors
                catalogProductNames.forEach(productName => {
                    if (!availableProducts.has(productName)) {
                        console.log(`Product "${productName}" has no colors defined, adding defaults`);
                        // These products are in catalog but have no colors defined
                        // Use standard mum colors as default
                        if (productName.toLowerCase().includes('tricolor')) {
                            availableProducts.set(productName, new Set(['Mixed']));
                        } else {
                            // Add standard mum colors for bundle products
                            availableProducts.set(productName, new Set(['Yellow', 'Orange', 'Red', 'White', 'Burgundy']));
                        }
                    }
                });
                
                // Debug: Log what we found
                console.log('Available products for PDF:');
                availableProducts.forEach((colors, product) => {
                    console.log(`  ${product}: ${Array.from(colors).join(', ')}`);
                });
                
            } catch (error) {
                console.error('Failed to fetch products for PDF:', error);
                // Fallback to hardcoded list if API fails
                const fallbackProducts = [
                    {name: '6" Small Pot', colors: ['Yellow', 'Orange', 'Red', 'White', 'Burgundy']},
                    {name: '8" Large Pot', colors: ['Yellow', 'Orange', 'Red', 'White', 'Burgundy']},
                    {name: '10" Hanging Basket', colors: ['Yellow', 'Orange', 'Red', 'White', 'Burgundy']},
                    {name: 'Oval Tricolor Pot', colors: ['Mixed']}
                ];
                
                fallbackProducts.forEach(product => {
                    availableProducts.set(product.name, new Set(product.colors));
                });
            }
            
            const productColorColumns = []; // Array of {product, color, index}
            
            // Sort products and colors, then create column index
            const sortedProductGroups = Array.from(availableProducts.entries()).sort((a, b) => a[0].localeCompare(b[0]));
            let columnIndex = 0;
            
            // Define standard color order for mums
            const colorOrder = ['Yellow', 'Orange', 'Red', 'White', 'Burgundy', 'Mixed'];
            
            sortedProductGroups.forEach(([productName, colors]) => {
                // Sort colors in the standard mum order
                const sortedColors = Array.from(colors).sort((a, b) => {
                    const aIndex = colorOrder.indexOf(a);
                    const bIndex = colorOrder.indexOf(b);
                    // If color not in standard order, put it at the end
                    if (aIndex === -1 && bIndex === -1) return a.localeCompare(b);
                    if (aIndex === -1) return 1;
                    if (bIndex === -1) return -1;
                    return aIndex - bIndex;
                });
                sortedColors.forEach(color => {
                    productColorColumns.push({
                        product: productName,
                        color: color,
                        index: columnIndex++,
                        key: `${productName}|${color}`
                    });
                });
            });
            
            // Color mapping for background colors
            const colorMap = {
                'orange': [255, 237, 213],
                'yellow': [255, 253, 224],
                'red': [255, 235, 238],
                'purple': [243, 229, 245],
                'burgundy': [248, 228, 232],
                'white': [250, 250, 250],
                'default': [245, 245, 245]
            };
            
            // Calculate column widths
            const fixedWidth = 270; // Scout + Customer + Total
            const availableWidth = 750 - fixedWidth;
            const productColumnWidth = Math.min(35, availableWidth / Math.max(productColorColumns.length, 1));
            
            // Build the header rows with proper cell objects for spanning
            const headerRow1 = [];
            const headerRow2 = [];
            
            // Add fixed columns
            headerRow1.push('Scout');
            headerRow1.push('Customer Name');
            headerRow1.push('Total');
            headerRow2.push('');
            headerRow2.push('');
            headerRow2.push('');
            
            // Group products to determine spans
            const productGroups = [];
            let currentProduct = '';
            let currentColors = [];
            
            productColorColumns.forEach((col) => {
                if (col.product !== currentProduct) {
                    if (currentProduct !== '') {
                        productGroups.push({
                            product: currentProduct,
                            colors: currentColors
                        });
                    }
                    currentProduct = col.product;
                    currentColors = [col.color];
                } else {
                    currentColors.push(col.color);
                }
            });
            
            // Add the last product group
            if (currentProduct !== '') {
                productGroups.push({
                    product: currentProduct,
                    colors: currentColors
                });
            }
            
            // Build header rows with spans
            productGroups.forEach((group) => {
                // For the first row, add the product name with colspan
                headerRow1.push({
                    content: group.product,
                    colSpan: group.colors.length
                });
                
                // For the second row, add each color
                group.colors.forEach(color => {
                    headerRow2.push(color);
                });
            });
            
            // Sort orders by Scout name first, then by Customer name
            const sortedOrders = [...allOrders].sort((a, b) => {
                // First sort by scout name
                const scoutA = (a.scout_name || '').toLowerCase();
                const scoutB = (b.scout_name || '').toLowerCase();
                
                if (scoutA !== scoutB) {
                    // Put empty scout names at the end
                    if (!scoutA) return 1;
                    if (!scoutB) return -1;
                    return scoutA.localeCompare(scoutB);
                }
                
                // If scout names are the same, sort by customer name
                const customerA = ((a.first_name || '') + ' ' + (a.last_name || '')).toLowerCase().trim();
                const customerB = ((b.first_name || '') + ' ' + (b.last_name || '')).toLowerCase().trim();
                return customerA.localeCompare(customerB);
            });
            
            // Prepare table data
            const tableData = [];
            const columnTotals = new Array(3 + productColorColumns.length).fill(0);
            columnTotals[0] = 'TOTALS';
            columnTotals[1] = '';
            let grandTotal = 0;
            
            sortedOrders.forEach(order => {
                const orderTotal = parseFloat(order.total_price || 0);
                grandTotal += orderTotal;
                
                const row = [
                    order.scout_name || '-',
                    (order.first_name || '') + ' ' + (order.last_name || ''),
                    '$' + orderTotal.toFixed(2)
                ];
                
                // Parse products for this order
                let products = order.products;
                if (typeof products === 'string') {
                    try {
                        products = JSON.parse(products);
                    } catch (e) {
                        products = [];
                    }
                }
                
                // Create product quantity map
                const orderProducts = new Map();
                if (products && Array.isArray(products)) {
                    products.forEach(product => {
                        const productName = product.title || product.name || 'Unknown';
                        let color = product.color;
                        
                        // Debug: log what we're processing
                        console.log(`Processing order product: ${productName}, color field: ${product.color}`);
                        
                        // If no color is specified, try to extract from title
                        if (!color) {
                            // Check if the product title contains color information
                            if (productName.includes(' - ')) {
                                const parts = productName.split(' - ');
                                color = parts[1].trim();
                                console.log(`  Extracted color from title: ${color}`);
                            } else if (productName.toLowerCase().includes('tricolor')) {
                                color = 'Mixed';
                                console.log(`  Detected tricolor, using Mixed`);
                            } else {
                                // For bundle products without specific color
                                // We'll handle them specially below
                                color = null;
                                console.log(`  No color found, this is likely a bundle product`);
                            }
                        }
                        
                        const qty = parseInt(product.quantity) || 0;
                        
                        // Handle products based on whether they have a color
                        if (!color && availableProducts.has(productName)) {
                            // This is a bundle product - show it in the first available color column
                            const colors = availableProducts.get(productName);
                            if (colors.size > 0) {
                                // Use the first color for bundle display
                                const firstColor = Array.from(colors)[0];
                                const key = `${productName}|${firstColor}`;
                                orderProducts.set(key, qty);
                                console.log(`  Bundle product placed in first color column: ${firstColor}`);
                            }
                        } else if (color) {
                            // Regular product with a specific color
                            const key = `${productName}|${color}`;
                            orderProducts.set(key, qty);
                        }
                    });
                }
                
                // Fill in quantities and update totals
                productColorColumns.forEach((col, index) => {
                    const qty = orderProducts.get(col.key) || '';
                    row.push(qty);
                    if (qty) {
                        columnTotals[index + 3] = (columnTotals[index + 3] || 0) + qty;
                    }
                });
                
                tableData.push(row);
            });
            
            // Format column totals
            columnTotals[2] = '$' + grandTotal.toFixed(2);
            for (let i = 3; i < columnTotals.length; i++) {
                if (columnTotals[i] === 0) columnTotals[i] = '';
            }
            
            // Add totals row to table data
            tableData.push(columnTotals);
            
            // Add title
            doc.setFontSize(16);
            doc.text('Pack 182 Mums Orders Report', doc.internal.pageSize.width / 2, 30, { align: 'center' });
            
            // Add date
            doc.setFontSize(10);
            const today = new Date();
            doc.text(`Generated: ${today.toLocaleDateString()} ${today.toLocaleTimeString()}`, doc.internal.pageSize.width / 2, 45, { align: 'center' });
            
            // Add summary stats
            const totalRevenue = sortedOrders.reduce((sum, order) => sum + parseFloat(order.total_price || 0), 0);
            doc.text(`Total Orders: ${sortedOrders.length} | Total Revenue: $${totalRevenue.toFixed(2)}`, doc.internal.pageSize.width / 2, 60, { align: 'center' });
            
            // Generate table with autoTable - complex header with column spans
            doc.autoTable({
                head: [headerRow1, headerRow2],
                body: tableData.slice(0, -1), // Exclude totals row for now
                foot: [tableData[tableData.length - 1]], // Add totals as footer
                startY: 75,
                styles: {
                    fontSize: 7,
                    cellPadding: 2,
                    overflow: 'linebreak',
                    halign: 'center',
                    lineColor: [180, 180, 180],
                    lineWidth: 0.25
                },
                headStyles: {
                    fillColor: [0, 63, 135],
                    textColor: [255, 255, 255],
                    fontSize: 7,
                    fontStyle: 'bold',
                    halign: 'center',
                    valign: 'middle'
                },
                footStyles: {
                    fillColor: [240, 240, 240],
                    textColor: [0, 0, 0],
                    fontSize: 8,
                    fontStyle: 'bold',
                    lineWidth: 1
                },
                columnStyles: {
                    0: { halign: 'left', cellWidth: 90 },   // Scout
                    1: { halign: 'left', cellWidth: 120 },  // Customer Name
                    2: { halign: 'right', cellWidth: 60 }   // Total
                },
                didParseCell: function(data) {
                    // Handle column widths for product columns
                    if (data.column.index >= 3) {
                        data.cell.styles.cellWidth = productColumnWidth;
                        data.cell.styles.fontSize = 6;
                        data.cell.styles.halign = 'center';
                    }
                    
                    // Color code the color header cells
                    if (data.section === 'head' && data.row.index === 1 && data.column.index >= 3) {
                        const colInfo = productColorColumns[data.column.index - 3];
                        if (colInfo) {
                            const colorName = colInfo.color.toLowerCase();
                            const bgColor = colorMap[colorName] || colorMap['default'];
                            data.cell.styles.fillColor = bgColor;
                            data.cell.styles.textColor = [0, 0, 0];
                            data.cell.styles.fontSize = 5;
                        }
                    }
                    
                    // Handle merged cells in first header row
                    if (data.section === 'head' && data.row.index === 0 && data.column.index >= 3) {
                        // Check if this should be a merged cell
                        let currentProductStart = 3;
                        let currentProductEnd = 3;
                        let currentProduct = '';
                        
                        for (let i = 0; i < productColorColumns.length; i++) {
                            if (productColorColumns[i].product !== currentProduct) {
                                if (currentProduct !== '' && data.column.index >= currentProductStart && data.column.index < currentProductEnd) {
                                    // This cell is part of a span
                                    if (data.column.index > currentProductStart) {
                                        data.cell.styles.fontSize = 0; // Hide text for spanned cells
                                    }
                                }
                                currentProduct = productColorColumns[i].product;
                                currentProductStart = i + 3;
                                currentProductEnd = currentProductStart + 1;
                            } else {
                                currentProductEnd++;
                            }
                        }
                    }
                    
                    // Alternating row colors
                    if (data.row.index % 2 === 0 && data.section === 'body') {
                        data.cell.styles.fillColor = [250, 250, 250];
                    }
                    
                    // Highlight totals row
                    if (data.section === 'foot') {
                        data.cell.styles.fillColor = [230, 230, 230];
                        data.cell.styles.fontStyle = 'bold';
                    }
                },
                margin: { top: 10, right: 10, bottom: 10, left: 10 },
                tableWidth: 'auto',
                showHead: 'everyPage'
            });
            
            // Add page numbers
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width - 50, doc.internal.pageSize.height - 20, { align: 'right' });
            }
            
            // Generate filename with date
            const dateStr = today.toISOString().split('T')[0];
            const filename = `Pack182_Orders_Report_${dateStr}.pdf`;
            
            // Save the PDF
            doc.save(filename);
            
            showMessage(`PDF report generated: ${filename}`, 'success');
        }
        
        // Tab switching
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tab === 'orders') {
                document.getElementById('orders-tab').classList.add('active');
                if (allOrders.length === 0) {
                    loadOrders();
                }
            } else if (tab === 'inventory') {
                document.getElementById('inventory-tab').classList.add('active');
                updateDateTime();
                loadInventory();
            } else if (tab === 'scouts') {
                document.getElementById('scouts-tab').classList.add('active');
                loadScoutNames();
            } else if (tab === 'qrcodes') {
                document.getElementById('qrcodes-tab').classList.add('active');
            } else if (tab === 'leaderboard') {
                document.getElementById('leaderboard-tab').classList.add('active');
            } else if (tab === 'helpers') {
                document.getElementById('helpers-tab').classList.add('active');
                loadHelpers();
            } else if (tab === 'settings') {
                document.getElementById('settings-tab').classList.add('active');
                loadSettings();
            }
        }
        
        function refreshCurrentView() {
            if (currentTab === 'orders') {
                showMessage('Refreshing orders...', 'success');
                loadOrders();
            } else if (currentTab === 'inventory') {
                showMessage('Refreshing inventory...', 'success');
                updateDateTime();
                loadInventory();
            } else if (currentTab === 'settings') {
                showMessage('Refreshing settings...', 'success');
                loadSettings();
            }
        }
        
        // Orders functionality
        async function loadOrders() {
            try {
                const response = await fetch(`${CONFIG.API_URL}?path=orders&admin=true`);
                const data = await response.json();
                
                if (data.orders) {
                    allOrders = data.orders;
                    displayOrders(allOrders);
                    updateOrderStats();
                } else {
                    showMessage('No orders found', 'error');
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                showMessage('Failed to load orders. Please try again.', 'error');
            }
        }
        
        function displayOrders(orders) {
            const container = document.getElementById('orders-container');
            filteredOrders = orders;
            
            if (orders.length === 0) {
                container.innerHTML = '<div class="error">No orders to display</div>';
                return;
            }
            
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Date</th>
                            <th>Scout</th>
                            <th>Customer</th>
                            <th class="hide-mobile">Email</th>
                            <th>Total</th>
                            <th>Payment</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            orders.forEach(order => {
                const date = new Date(order.timestamp);
                const dateStr = date.toLocaleDateString();
                
                html += `
                    <tr>
                        <td>${order.order_id}</td>
                        <td>${dateStr}</td>
                        <td>${order.scout_name || '-'}</td>
                        <td>${order.first_name} ${order.last_name}</td>
                        <td class="hide-mobile">${order.email}</td>
                        <td>$${order.total_price}</td>
                        <td><span class="status-badge status-${(order.payment_status || 'pending').toLowerCase()}">${order.payment_status || 'PENDING'}</span></td>
                        <td><span class="status-badge status-${(order.order_status || 'new').toLowerCase()}">${order.order_status || 'NEW'}</span></td>
                        <td><button class="btn btn-primary" onclick="viewOrder('${order.order_id}')">View</button></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function filterOrders() {
            const paymentFilter = document.getElementById('payment-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            let filtered = allOrders;
            
            if (paymentFilter) {
                filtered = filtered.filter(order => order.payment_status === paymentFilter);
            }
            
            if (statusFilter) {
                filtered = filtered.filter(order => order.order_status === statusFilter);
            }
            
            if (searchTerm) {
                filtered = filtered.filter(order => {
                    const fullName = `${order.first_name} ${order.last_name}`.toLowerCase();
                    return fullName.includes(searchTerm) || 
                           order.order_id.toLowerCase().includes(searchTerm) ||
                           order.email.toLowerCase().includes(searchTerm);
                });
            }
            
            displayOrders(filtered);
        }
        
        function updateOrderStats() {
            const totalOrders = allOrders.length;
            const totalRevenue = allOrders.reduce((sum, order) => sum + parseFloat(order.total_price || 0), 0);
            const pendingPayments = allOrders.filter(order => order.payment_status !== 'PAID').length;
            const newOrders = allOrders.filter(order => order.order_status === 'NEW').length;
            
            document.getElementById('total-orders').textContent = totalOrders;
            document.getElementById('total-revenue').textContent = '$' + totalRevenue.toFixed(2);
            document.getElementById('pending-payments').textContent = pendingPayments;
            document.getElementById('new-orders').textContent = newOrders;
        }
        
        function viewOrder(orderId) {
            const order = allOrders.find(o => o.order_id === orderId);
            if (!order) return;
            
            let products = order.products;
            if (typeof products === 'string') {
                try {
                    products = JSON.parse(products);
                } catch (e) {
                    products = [];
                }
            }
            
            let productsHtml = '';
            products.forEach(product => {
                productsHtml += `
                    <div class="product-item">
                        <strong>${product.title}</strong> - ${product.color}<br>
                        Quantity: ${product.quantity} √ó $${product.price} = $${(product.quantity * product.price).toFixed(2)}
                    </div>
                `;
            });
            
            const html = `
                <div class="order-details">
                    <h3>Order Information</h3>
                    <div class="detail-row">
                        <span class="detail-label">Order ID:</span>
                        <span>${order.order_id}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Date:</span>
                        <span>${new Date(order.timestamp).toLocaleString()}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Payment Method:</span>
                        <span>${order.payment_method}</span>
                    </div>
                    
                    <h3>Customer Information</h3>
                    <div class="detail-row">
                        <span class="detail-label">Name:</span>
                        <span>${order.first_name} ${order.last_name}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Email:</span>
                        <span>${order.email}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Phone:</span>
                        <span>${order.phone}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Address:</span>
                        <span>${order.address.replace(/\n/g, '<br>')}</span>
                    </div>
                    
                    <h3>Products</h3>
                    <div class="product-list">
                        ${productsHtml}
                    </div>
                    
                    <h3>Total</h3>
                    <div class="detail-row">
                        <span class="detail-label">Total Amount:</span>
                        <span style="font-size: 20px; font-weight: bold;">$${order.total_price}</span>
                    </div>
                    
                    ${order.comments ? `
                    <h3>Comments</h3>
                    <div style="padding: 10px; background: #f7fafc; border-radius: 5px;">
                        ${order.comments}
                    </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('order-details').innerHTML = html;
            document.getElementById('order-modal').style.display = 'flex';
        }
        
        function closeModal() {
            document.getElementById('order-modal').style.display = 'none';
        }
        
        // Export orders to CSV
        function exportOrders() {
            if (filteredOrders.length === 0) {
                showMessage('No orders to export', 'error');
                return;
            }
            
            const headers = ['Order ID', 'Date', 'First Name', 'Last Name', 'Email', 'Phone', 'Address', 
                           'Products', 'Total', 'Payment Method', 'Payment Status', 'Order Status', 'Comments'];
            
            const csvRows = [headers.join(',')];
            
            filteredOrders.forEach(order => {
                const products = typeof order.products === 'string' ? 
                    JSON.parse(order.products) : order.products;
                
                const productsList = products.map(p => 
                    `${p.title || p.name} (${p.color}): ${p.quantity}`
                ).join('; ');
                
                const row = [
                    order.order_id,
                    new Date(order.timestamp).toLocaleString(),
                    order.first_name,
                    order.last_name,
                    order.email,
                    order.phone,
                    `"${order.address.replace(/"/g, '""').replace(/\n/g, ' ')}"`,
                    `"${productsList}"`,
                    order.total_price,
                    order.payment_method,
                    order.payment_status,
                    order.order_status,
                    `"${(order.comments || '').replace(/"/g, '""')}"`
                ];
                
                csvRows.push(row.join(','));
            });
            
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', `mums_orders_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showMessage('Orders exported successfully', 'success');
        }
        
        // Inventory functionality
        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const timeStr = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('summary-date').textContent = `Generated on ${dateStr} at ${timeStr}`;
        }
        
        async function loadInventory() {
            // Disable buttons while loading
            const printBtn = document.getElementById('print-summary-btn');
            if (printBtn) {
                printBtn.disabled = true;
            }
            const vendorBtn = document.getElementById('vendor-spreadsheet-btn');
            if (vendorBtn) {
                vendorBtn.disabled = true;
            }
            
            try {
                if (allOrders.length === 0) {
                    const response = await fetch(`${CONFIG.API_URL}?path=orders&admin=true`);
                    const data = await response.json();
                    if (data.orders) {
                        allOrders = data.orders;
                    }
                }
                
                processInventory();
                displayInventory();
                updateInventoryStats();
                
                // Enable buttons after successful load
                const printBtn = document.getElementById('print-summary-btn');
                if (printBtn) {
                    printBtn.disabled = false;
                }
                const vendorBtn = document.getElementById('vendor-spreadsheet-btn');
                if (vendorBtn) {
                    vendorBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error loading inventory:', error);
                showMessage('Failed to load inventory data. Please try again.', 'error');
                document.getElementById('inventory-container').innerHTML = 
                    '<div class="error">Unable to load inventory data</div>';
                
                // Keep buttons disabled on error
                const printBtn = document.getElementById('print-summary-btn');
                if (printBtn) {
                    printBtn.disabled = true;
                }
                const vendorBtn = document.getElementById('vendor-spreadsheet-btn');
                if (vendorBtn) {
                    vendorBtn.disabled = true;
                }
            }
        }
        
        function processInventory() {
            inventoryData = {};
            
            allOrders.forEach(order => {
                let products = order.products;
                if (typeof products === 'string') {
                    try {
                        products = JSON.parse(products);
                    } catch (e) {
                        console.error('Failed to parse products for order:', order.order_id);
                        return;
                    }
                }
                
                products.forEach(product => {
                    const productName = product.title || product.name || 'Unknown Product';
                    const color = product.color || 'No Color';
                    const quantity = parseInt(product.quantity) || 0;
                    
                    if (!inventoryData[productName]) {
                        inventoryData[productName] = {
                            colors: {},
                            total: 0,
                            price: parseFloat(product.price) || 0
                        };
                    }
                    
                    if (!inventoryData[productName].colors[color]) {
                        inventoryData[productName].colors[color] = 0;
                    }
                    inventoryData[productName].colors[color] += quantity;
                    inventoryData[productName].total += quantity;
                });
            });
        }
        
        function displayInventory() {
            const container = document.getElementById('inventory-container');
            
            if (Object.keys(inventoryData).length === 0) {
                container.innerHTML = '<div class="error">No inventory data to display</div>';
                return;
            }
            
            const allColors = new Set();
            Object.values(inventoryData).forEach(product => {
                Object.keys(product.colors).forEach(color => allColors.add(color));
            });
            const colorList = Array.from(allColors).sort();
            
            let html = `
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th style="width: 30%;">Product</th>
                            ${colorList.map(color => `<th style="text-align: center;">${color}</th>`).join('')}
                            <th style="text-align: center; background: #e6fffa;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let grandTotalByColor = {};
            colorList.forEach(color => grandTotalByColor[color] = 0);
            let grandTotal = 0;
            
            Object.keys(inventoryData).sort().forEach(productName => {
                const product = inventoryData[productName];
                
                html += `<tr class="product-row">`;
                html += `<td class="product-header">${productName}</td>`;
                
                colorList.forEach(color => {
                    const qty = product.colors[color] || 0;
                    grandTotalByColor[color] += qty;
                    html += `<td class="quantity-cell">${qty > 0 ? qty : '-'}</td>`;
                });
                
                html += `<td class="quantity-cell total-row">${product.total}</td>`;
                html += `</tr>`;
                
                grandTotal += product.total;
            });
            
            html += `<tr class="grand-total-row">`;
            html += `<td><strong>GRAND TOTAL</strong></td>`;
            colorList.forEach(color => {
                html += `<td class="quantity-cell">${grandTotalByColor[color]}</td>`;
            });
            html += `<td class="quantity-cell">${grandTotal}</td>`;
            html += `</tr>`;
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        function updateInventoryStats() {
            const totalOrders = allOrders.length;
            let totalMums = 0;
            let totalRevenue = 0;
            
            Object.values(inventoryData).forEach(product => {
                totalMums += product.total;
                totalRevenue += product.total * product.price;
            });
            
            document.getElementById('inv-total-orders').textContent = totalOrders;
            document.getElementById('inv-total-mums').textContent = totalMums;
            document.getElementById('inv-total-revenue').textContent = '$' + totalRevenue.toFixed(2);
        }
        
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('message-area');
            messageArea.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 3000);
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('order-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
        
        // Helpers functionality
        let allHelpers = [];
        
        async function loadHelpers() {
            try {
                // Load helpers from Sheets API
                const response = await fetch(`${CONFIG.API_URL}?path=helpers&admin=true`);
                const data = await response.json();
                
                if (data.helpers) {
                    allHelpers = data.helpers;
                } else {
                    allHelpers = [];
                }
                
                displayHelpers(allHelpers);
                updateHelpersStats();
                
                // Set up search listener
                const searchInput = document.getElementById('helpers-search');
                if (searchInput && !searchInput.hasAttribute('data-listener-added')) {
                    searchInput.setAttribute('data-listener-added', 'true');
                    searchInput.addEventListener('input', filterHelpers);
                }
            } catch (error) {
                console.error('Error loading helpers:', error);
                showMessage('Failed to load helpers', 'error');
                // Fallback to empty array
                allHelpers = [];
                displayHelpers(allHelpers);
                updateHelpersStats();
            }
        }
        
        function displayHelpers(helpers) {
            const tbody = document.querySelector('#helpers-table tbody');
            tbody.innerHTML = '';
            
            if (helpers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No helper requests yet</td></tr>';
                return;
            }
            
            // Sort by date, newest first
            helpers.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            helpers.forEach(helper => {
                const row = document.createElement('tr');
                const date = new Date(helper.date);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours() % 12 || 12}:${String(date.getMinutes()).padStart(2, '0')} ${date.getHours() >= 12 ? 'PM' : 'AM'}`;
                
                // Apply dimmed style if contacted
                if (helper.contacted) {
                    row.style.opacity = '0.5';
                    row.style.backgroundColor = '#f9f9f9';
                }
                
                row.innerHTML = `
                    <td style="text-align: center; padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <input type="checkbox" 
                               ${helper.contacted ? 'checked' : ''} 
                               onchange="toggleHelperContacted('${helper.id}', this.checked)"
                               style="width: 20px; height: 20px; cursor: pointer;">
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${dateStr}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${helper.name || '-'}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;"><a href="mailto:${helper.email}" style="${helper.contacted ? 'color: #999;' : ''}">${helper.email}</a></td>
                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${helper.scoutName || '-'}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                        <input type="text" 
                               value="${helper.contactedBy || ''}" 
                               placeholder="Who reached out?"
                               onchange="updateContactedBy('${helper.id}', this.value)"
                               style="width: 90%; padding: 5px; border: 1px solid #ddd; border-radius: 3px; ${helper.contacted ? 'background-color: #f9f9f9;' : ''}">
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        async function toggleHelperContacted(helperId, isContacted) {
            const helperIndex = allHelpers.findIndex(h => h.id === helperId);
            if (helperIndex !== -1) {
                const helper = allHelpers[helperIndex];
                helper.contacted = isContacted;
                if (!isContacted) {
                    helper.contactedBy = '';
                }
                
                try {
                    // Update in Sheets
                    const response = await fetch(`${CONFIG.API_URL}?path=updateHelper&admin=true`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain'
                        },
                        body: JSON.stringify({
                            id: helperId,
                            contacted: isContacted,
                            contactedBy: helper.contactedBy
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        displayHelpers(allHelpers);
                        updateHelpersStats();
                        showMessage(isContacted ? 'Marked as contacted' : 'Unmarked as contacted', 'success');
                    } else {
                        throw new Error('Failed to update helper');
                    }
                } catch (error) {
                    console.error('Error updating helper:', error);
                    showMessage('Failed to update helper status', 'error');
                    // Revert the change
                    helper.contacted = !isContacted;
                    displayHelpers(allHelpers);
                }
            }
        }
        
        async function updateContactedBy(helperId, contactedBy) {
            const helperIndex = allHelpers.findIndex(h => h.id === helperId);
            if (helperIndex !== -1) {
                const helper = allHelpers[helperIndex];
                const previousContactedBy = helper.contactedBy;
                const previousContacted = helper.contacted;
                
                helper.contactedBy = contactedBy;
                if (contactedBy) {
                    helper.contacted = true;
                }
                
                try {
                    // Update in Sheets
                    const response = await fetch(`${CONFIG.API_URL}?path=updateHelper&admin=true`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain'
                        },
                        body: JSON.stringify({
                            id: helperId,
                            contacted: helper.contacted,
                            contactedBy: contactedBy
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        displayHelpers(allHelpers);
                        updateHelpersStats();
                    } else {
                        throw new Error('Failed to update helper');
                    }
                } catch (error) {
                    console.error('Error updating helper:', error);
                    // Revert the changes
                    helper.contactedBy = previousContactedBy;
                    helper.contacted = previousContacted;
                    displayHelpers(allHelpers);
                }
            }
        }
        
        function updateHelpersStats() {
            const totalHelpers = allHelpers.length;
            const pendingHelpers = allHelpers.filter(h => !h.contacted).length;
            const contactedHelpers = allHelpers.filter(h => h.contacted).length;
            
            document.getElementById('total-helpers').textContent = totalHelpers;
            document.getElementById('pending-helpers').textContent = pendingHelpers;
            document.getElementById('contacted-helpers').textContent = contactedHelpers;
        }
        
        function filterHelpers() {
            const searchTerm = document.getElementById('helpers-search').value.toLowerCase();
            
            if (!searchTerm) {
                displayHelpers(allHelpers);
                return;
            }
            
            const filtered = allHelpers.filter(helper => {
                return (helper.name && helper.name.toLowerCase().includes(searchTerm)) ||
                       (helper.email && helper.email.toLowerCase().includes(searchTerm)) ||
                       (helper.scoutName && helper.scoutName.toLowerCase().includes(searchTerm)) ||
                       (helper.contactedBy && helper.contactedBy.toLowerCase().includes(searchTerm));
            });
            
            displayHelpers(filtered);
        }
        
        // Settings functionality
        let currentSettings = {};
        
        async function loadSettings() {
            try {
                const response = await fetch(`${CONFIG.API_URL}?path=settings`);
                const data = await response.json();
                
                if (data.settings) {
                    currentSettings = data.settings;
                    
                    // Populate all setting fields
                    Object.keys(currentSettings).forEach(key => {
                        const element = document.getElementById(`setting-${key}`);
                        if (element) {
                            element.value = currentSettings[key] || '';
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                showMessage('Failed to load settings. Please try again.', 'error');
            }
        }
        
        // Scout Names Management Functions
        let scoutData = {};
        
        async function loadScoutNames() {
            try {
                // Get all orders to extract scout names
                const response = await fetch(`${CONFIG.API_URL}?path=orders&admin=true`);
                const data = await response.json();
                
                if (data.orders) {
                    // Process scout names from orders
                    scoutData = {};
                    const scoutFilter = document.getElementById('scout-filter');
                    scoutFilter.innerHTML = '<option value="">All Scouts</option>';
                    
                    data.orders.forEach(order => {
                        const scoutName = order.scout_name || 'Unknown Scout';
                        if (!scoutData[scoutName]) {
                            scoutData[scoutName] = {
                                original: scoutName,
                                standardized: scoutName,
                                orders: 0,
                                revenue: 0
                            };
                        }
                        scoutData[scoutName].orders++;
                        scoutData[scoutName].revenue += parseFloat(order.total_price || 0);
                    });
                    
                    // Display scout names table
                    displayScoutNames();
                    
                    // Update scout stats
                    updateScoutStats();
                    
                    // Populate scout filter dropdown
                    Object.keys(scoutData).sort().forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = `${name} (${scoutData[name].orders} orders)`;
                        scoutFilter.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading scout names:', error);
                showMessage('Failed to load scout data', 'error');
            }
        }
        
        function displayScoutNames() {
            const tbody = document.getElementById('scout-names-list');
            let html = '';
            
            Object.keys(scoutData).sort().forEach(name => {
                const scout = scoutData[name];
                html += `
                    <tr>
                        <td>${scout.original}</td>
                        <td>
                            <input type="text" 
                                   value="${scout.standardized}" 
                                   onchange="updateScoutName('${scout.original}', this.value)"
                                   style="width: 100%; padding: 5px; border: 1px solid #e2e8f0; border-radius: 3px;">
                        </td>
                        <td>${scout.orders}</td>
                        <td>$${scout.revenue.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        function updateScoutName(original, newName) {
            if (scoutData[original]) {
                scoutData[original].standardized = newName;
            }
        }
        
        async function saveScoutNames() {
            try {
                // In a real implementation, this would save to the backend
                showMessage('Scout names updated successfully', 'success');
                
                // Refresh the display
                loadScoutNames();
            } catch (error) {
                console.error('Error saving scout names:', error);
                showMessage('Failed to save scout names', 'error');
            }
        }
        
        function updateScoutStats() {
            const totalScouts = Object.keys(scoutData).length;
            let topScout = '-';
            let topRevenue = 0;
            
            Object.keys(scoutData).forEach(name => {
                if (scoutData[name].revenue > topRevenue) {
                    topRevenue = scoutData[name].revenue;
                    topScout = name;
                }
            });
            
            document.getElementById('total-scouts').textContent = totalScouts;
            document.getElementById('top-scout').textContent = topScout;
            document.getElementById('top-revenue').textContent = `$${topRevenue.toFixed(2)}`;
        }
        
        // Filter orders by scout
        function filterOrders() {
            const paymentFilter = document.getElementById('payment-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            const searchInput = document.getElementById('search-input').value.toLowerCase();
            const scoutFilter = document.getElementById('scout-filter').value;
            
            let filtered = allOrders;
            
            if (paymentFilter) {
                filtered = filtered.filter(order => order.payment_status === paymentFilter);
            }
            
            if (statusFilter) {
                filtered = filtered.filter(order => order.order_status === statusFilter);
            }
            
            if (scoutFilter) {
                filtered = filtered.filter(order => order.scout_name === scoutFilter);
            }
            
            if (searchInput) {
                filtered = filtered.filter(order => {
                    return order.order_id.toLowerCase().includes(searchInput) ||
                           `${order.first_name} ${order.last_name}`.toLowerCase().includes(searchInput) ||
                           (order.scout_name && order.scout_name.toLowerCase().includes(searchInput));
                });
            }
            
            displayOrders(filtered);
        }
        
        async function saveSetting(key, value) {
            try {
                currentSettings[key] = value;
                
                const response = await fetch(`${CONFIG.API_URL}?path=updateSettings&admin=true`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify({ [key]: value })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`${key.replace(/_/g, ' ')} updated successfully`, 'success');
                } else {
                    showMessage('Failed to save setting', 'error');
                }
            } catch (error) {
                console.error('Error saving setting:', error);
                showMessage('Failed to save setting. Please try again.', 'error');
            }
        }
    </script>
</body>
</html>